local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

local REBIRTH_INTERVAL = 3600
local isAutoRebirthEnabled = false
local rebirthThread = nil

local Window = Rayfield:CreateWindow({
    Name = "Auto Rebirth Machine",
    LoadingTitle = "Rebirth Machine",
    LoadingSubtitle = "by Zacharificy",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "AutoRebirthConfig",
        FileName = "config"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = true
    },
    KeySystem = false
})

local MainTab = Window:CreateTab("Main", nil)

local StatusSection = MainTab:CreateSection("Status")

local statusLabel = MainTab:CreateLabel("Status: Disabled")

local RebirthSection = MainTab:CreateSection("Rebirth Machine Settings")

local function getValidSecretPets()
    local validPets = {}
    
    local args = {"GetExisting", "Giant Bongo Kitty"}
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Framework"):WaitForChild("Network"):WaitForChild("Remote"):WaitForChild("RemoteFunction"):InvokeServer(unpack(args))
    end)
    
    if not success then
        warn("Failed to get pets inventory:", result)
        return validPets
    end
    
    if not result then
        warn("No result from GetExisting")
        return validPets
    end
    
    if type(result) == "table" then
        for _, petData in pairs(result) do
            if type(petData) == "string" then
                table.insert(validPets, petData)
            end
        end
    end
    
    return validPets
end

local function useRebirthMachine()
    local validPets = getValidSecretPets()
    
    if #validPets < 5 then
        statusLabel:Set("Status: Not enough pets (" .. #validPets .. "/5)")
        return false
    end
    
    local selectedPets = {}
    for i = 1, 5 do
        table.insert(selectedPets, validPets[i])
    end
    
    local args = {
        "UseRebirthMachine",
        selectedPets
    }
    
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Framework"):WaitForChild("Network"):WaitForChild("Remote"):WaitForChild("RemoteFunction"):InvokeServer(unpack(args))
    end)
    
    if success then
        statusLabel:Set("Status: Machine used successfully!")
        return true
    else
        statusLabel:Set("Status: Machine failed")
        return false
    end
end

local function startAutoRebirth()
    rebirthThread = task.spawn(function()
        while isAutoRebirthEnabled do
            useRebirthMachine()
            
            if isAutoRebirthEnabled then
                for i = REBIRTH_INTERVAL, 0, -1 do
                    if not isAutoRebirthEnabled then break end
                    local minutes = math.floor(i / 60)
                    local seconds = i % 60
                    statusLabel:Set(string.format("Status: Next use in %02d:%02d", minutes, seconds))
                    task.wait(1)
                end
            end
        end
    end)
end

local function stopAutoRebirth()
    if rebirthThread then
        task.cancel(rebirthThread)
        rebirthThread = nil
    end
end

local AutoRebirthToggle = MainTab:CreateToggle({
    Name = "Enable Auto Machine",
    CurrentValue = false,
    Flag = "AutoRebirthToggle",
    Callback = function(Value)
        isAutoRebirthEnabled = Value
        
        if Value then
            statusLabel:Set("Status: Enabled")
            Rayfield:Notify({
                Title = "Rebirth Machine",
                Content = "Auto machine has been enabled",
                Duration = 3,
                Image = nil,
            })
            startAutoRebirth()
        else
            statusLabel:Set("Status: Disabled")
            Rayfield:Notify({
                Title = "Rebirth Machine",
                Content = "Auto machine has been disabled",
                Duration = 3,
                Image = nil,
            })
            stopAutoRebirth()
        end
    end,
})

local IntervalSlider = MainTab:CreateSlider({
    Name = "Machine Interval (minutes)",
    Range = {1, 120},
    Increment = 1,
    Suffix = "min",
    CurrentValue = 60,
    Flag = "IntervalSlider",
    Callback = function(Value)
        REBIRTH_INTERVAL = Value * 60
        Rayfield:Notify({
            Title = "Interval Updated",
            Content = "Machine interval set to " .. Value .. " minutes",
            Duration = 2,
            Image = nil,
        })
    end,
})

local InfoSection = MainTab:CreateSection("Information")

MainTab:CreateParagraph({
    Title = "How to Use",
    Content = "This script automatically uses the rebirth machine every hour using 5 Giant Bongo Kitty pets. Make sure you have at least 5 unequipped, non-shiny, non-mythic Giant Bongo Kitty pets in your inventory."
})

local UtilityTab = Window:CreateTab("Utility", nil)

local UtilitySection = UtilityTab:CreateSection("Script Control")

UtilityTab:CreateButton({
    Name = "Check Pet Count",
    Callback = function()
        local validPets = getValidSecretPets()
        local args = {"GetExisting", "Giant Bongo Kitty"}
        local success, result = pcall(function()
            return ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Framework"):WaitForChild("Network"):WaitForChild("Remote"):WaitForChild("RemoteFunction"):InvokeServer(unpack(args))
        end)
        
        local debugInfo = "Valid: " .. #validPets .. "\n"
        if success and result then
            debugInfo = debugInfo .. "Total returned: " .. (type(result) == "table" and #result or "not table")
        else
            debugInfo = debugInfo .. "Failed to get data"
        end
        
        Rayfield:Notify({
            Title = "Pet Count",
            Content = debugInfo,
            Duration = 5,
            Image = nil,
        })
    end,
})

UtilityTab:CreateButton({
    Name = "Use Machine Now",
    Callback = function()
        local success = useRebirthMachine()
        if success then
            Rayfield:Notify({
                Title = "Machine",
                Content = "Machine used successfully!",
                Duration = 3,
                Image = nil,
            })
        else
            Rayfield:Notify({
                Title = "Machine Failed",
                Content = "Could not use machine",
                Duration = 3,
                Image = nil,
            })
        end
    end,
})

Rayfield:LoadConfiguration()
