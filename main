local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

getgenv().Functions = {
    AutoRebirthMachine = false,
    AutoBlowBubbles = false
}

local REBIRTH_INTERVAL = 3600

local Remote, LocalData
local success1, err1 = pcall(function()
    Remote = require(ReplicatedStorage.Shared.Framework.Network.Remote)
end)
local success2, err2 = pcall(function()
    LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
end)

if not success1 then
    warn("Failed to load Remote:", err1)
end
if not success2 then
    warn("Failed to load LocalData:", err2)
end

local Window = Rayfield:CreateWindow({
    Name = "Bubble Gum Simulator",
    LoadingTitle = "BGS Auto Farm",
    LoadingSubtitle = "by CSAM",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "BGSAutoFarm",
        FileName = "config"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = true
    },
    KeySystem = false
})

local MainTab = Window:CreateTab("Main", nil)
local MainSection = MainTab:CreateSection("Main Functions")

MainTab:CreateToggle({
    Name = "Auto Blow Bubbles",
    CurrentValue = false,
    Flag = "AutoBlowBubbles",
    
    Callback = function(Value)
        getgenv().Functions.AutoBlowBubbles = Value
        task.spawn(function()
            while Functions.AutoBlowBubbles do
                pcall(function()
                    task.wait()
                    if Remote then
                        Remote:FireServer("BlowBubble")
                    end
                end)
            end
        end)
    end
})

MainTab:CreateToggle({
    Name = "Auto Sell Bubbles",
    CurrentValue = false,
    Flag = "AutoSellBubbles",
    
    Callback = function(Value)
        getgenv().Functions.AutoSellBubbles = Value
        task.spawn(function()
            while Functions.AutoSellBubbles do
                pcall(function()
                    task.wait()
                    if Remote then
                        Remote:FireServer("SellBubble")
                    end
                end)
            end
        end)
    end
})

local RebirthTab = Window:CreateTab("Rebirth", nil)
local StatusSection = RebirthTab:CreateSection("Status")
local statusLabel = RebirthTab:CreateLabel("Status: Disabled")
local RebirthSection = RebirthTab:CreateSection("Rebirth Machine Settings")

local originalPosition = nil

local function findRebirthMachine()
    local workspace = game:GetService("Workspace")
    
    local success, rebirthMachine = pcall(function()
        return workspace:WaitForChild("RebirthMachine"):WaitForChild("Activation"):WaitForChild("Ring")
    end)
    
    if success and rebirthMachine then
        return rebirthMachine
    end
    
    return nil
end

local function teleportToRebirthMachine()
    local character = player.Character
    if not character then return false end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    originalPosition = humanoidRootPart.CFrame
    
    local rebirthMachine = findRebirthMachine()
    if not rebirthMachine then
        statusLabel:Set("Status: Rebirth machine not found")
        return false
    end
    
    local targetCFrame
    if rebirthMachine:IsA("Model") then
        targetCFrame = rebirthMachine:GetPivot()
    elseif rebirthMachine:IsA("BasePart") then
        targetCFrame = rebirthMachine.CFrame
    else
        return false
    end
    
    -- Teleport directly onto the ring
    humanoidRootPart.CFrame = targetCFrame
    
    return true
end

local function teleportBack()
    if originalPosition then
        local character = player.Character
        if character then
            local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
            if humanoidRootPart then
                humanoidRootPart.CFrame = originalPosition
            end
        end
    end
end

local function getValidSecretPets()
    local validPets = {}
    
    if not LocalData then
        warn("LocalData module not loaded")
        return validPets
    end
    
    local success, data = pcall(function()
        return LocalData:Get()
    end)
    
    if not success or not data or not data.Pets then
        warn("No pet data found")
        return validPets
    end
    
    for petGUID, petData in pairs(data.Pets) do
        if type(petData) == "table" then
            local petName = petData.Name or ""
            local isEquipped = petData.Equipped or false
            local isShiny = petData.Shiny or false
            local isMythic = petData.Mythic or false
            
            if petName == "Giant Bongo Kitty" and not isEquipped and not isShiny and not isMythic then
                table.insert(validPets, petGUID)
            end
        end
    end
    
    return validPets
end

local function findRebirthGUI()
    -- Check Workspace first (from your original code)
    local workspace = game:GetService("Workspace")
    local billboardGui = workspace:FindFirstChild("RebirthMachine")
    if billboardGui then
        billboardGui = billboardGui:FindFirstChild("Activation")
        if billboardGui then
            billboardGui = billboardGui:FindFirstChild("Root")
            if billboardGui then
                billboardGui = billboardGui:FindFirstChild("BillboardGui")
                if billboardGui then
                    return billboardGui
                end
            end
        end
    end
    
    -- Also check PlayerGui
    local PlayerGui = player:WaitForChild("PlayerGui")
    for _, gui in pairs(PlayerGui:GetChildren()) do
        if gui.Name:lower():find("rebirth") or gui.Name:lower():find("machine") then
            return gui
        end
    end
    
    return nil
end

local function findPetSlots(gui)
    -- Find all slot buttons (buttons with + icon or that open pet inventory)
    local slots = {}
    
    for _, descendant in ipairs(gui:GetDescendants()) do
        if descendant:IsA("GuiButton") or descendant:IsA("TextButton") or descendant:IsA("ImageButton") then
            -- Look for buttons that might be pet slots
            local name = descendant.Name:lower()
            local text = descendant:IsA("TextButton") and descendant.Text or ""
            
            -- Check if it's a slot button (has + or is named like a slot)
            if text:find("+") or name:find("slot") or name:find("pet") then
                table.insert(slots, descendant)
            end
        end
    end
    
    return slots
end

local function clickPetInInventory(petGUID)
    -- After clicking a slot, the pet inventory should open (likely in PlayerGui)
    task.wait(0.5)
    
    local PlayerGui = player:WaitForChild("PlayerGui")
    
    -- Find the pet inventory GUI that opened
    for _, gui in pairs(PlayerGui:GetChildren()) do
        for _, descendant in ipairs(gui:GetDescendants()) do
            if descendant:IsA("ScrollingFrame") then
                -- Found a scrolling frame, likely the pet inventory
                print("Found pet inventory ScrollingFrame:", descendant:GetFullName())
                
                -- Scroll through to find the pet
                for scrollPos = 0, 1, 0.1 do
                    descendant.CanvasPosition = Vector2.new(0, descendant.AbsoluteCanvasSize.Y * scrollPos)
                    task.wait(0.05)
                    
                    -- Look for the pet button
                    for _, child in ipairs(descendant:GetDescendants()) do
                        if child:IsA("GuiButton") or child:IsA("TextButton") or child:IsA("ImageButton") then
                            local guid = child:FindFirstChild("PetGUID") or child:GetAttribute("PetGUID")
                            if guid and tostring(guid) == petGUID then
                                print("Found pet, clicking it:", petGUID)
                                -- Found the pet, click it
                                for _, connection in pairs(getconnections(child.MouseButton1Click)) do
                                    connection:Fire()
                                end
                                task.wait(0.3)
                                return true
                            end
                        end
                    end
                end
            end
        end
    end
    
    return false
end

local function clickConvertButton(gui)
    -- Search for convert button
    for _, descendant in ipairs(gui:GetDescendants()) do
        if descendant:IsA("GuiButton") or descendant:IsA("TextButton") or descendant:IsA("ImageButton") then
            if descendant.Name:lower():find("convert") then
                print("Found convert button:", descendant:GetFullName())
                for _, connection in pairs(getconnections(descendant.MouseButton1Click)) do
                    connection:Fire()
                end
                return true
            end
        end
    end
    
    warn("Could not find convert button")
    return false
end

local function clickClaimButton()
    task.wait(2) -- Wait for the reward UI to appear
    
    local PlayerGui = player:WaitForChild("PlayerGui")
    
    -- Look for claim/collect button in any GUI
    for _, gui in pairs(PlayerGui:GetChildren()) do
        for _, descendant in ipairs(gui:GetDescendants()) do
            if descendant:IsA("GuiButton") or descendant:IsA("TextButton") or descendant:IsA("ImageButton") then
                local name = descendant.Name:lower()
                if name:find("claim") or name:find("collect") or name:find("ok") or name:find("continue") then
                    print("Found claim button:", descendant:GetFullName())
                    for _, connection in pairs(getconnections(descendant.MouseButton1Click)) do
                        connection:Fire()
                    end
                    return true
                end
            end
        end
    end
    
    warn("Could not find claim button")
    return false
end

local function useRebirthMachine()
    statusLabel:Set("Status: Getting valid pets...")
    
    local validPets = getValidSecretPets()
    
    if #validPets < 5 then
        statusLabel:Set("Status: Not enough pets (" .. #validPets .. "/5)")
        Rayfield:Notify({
            Title = "Not Enough Pets",
            Content = "Need 5 Giant Bongo Kitty pets, found: " .. #validPets,
            Duration = 3,
            Image = nil,
        })
        return false
    end
    
    local selectedPets = {}
    for i = 1, 5 do
        table.insert(selectedPets, validPets[i])
    end
    
    statusLabel:Set("Status: Teleporting to machine...")
    
    if not teleportToRebirthMachine() then
        Rayfield:Notify({
            Title = "Failed",
            Content = "Could not find rebirth machine",
            Duration = 3,
            Image = nil,
        })
        return false
    end
    
    task.wait(2) -- Wait for the UI to open from proximity
    
    statusLabel:Set("Status: Finding rebirth UI...")
    
    local gui = findRebirthGUI()
    if not gui then
        teleportBack()
        statusLabel:Set("Status: Could not find rebirth UI")
        Rayfield:Notify({
            Title = "Failed",
            Content = "Rebirth UI not found",
            Duration = 4,
            Image = nil,
        })
        return false
    end
    
    print("Found rebirth GUI:", gui:GetFullName())
    
    -- Find the pet slots (buttons with + icon)
    statusLabel:Set("Status: Finding pet slots...")
    local slots = findPetSlots(gui)
    
    if #slots < 5 then
        teleportBack()
        statusLabel:Set("Status: Not enough pet slots found")
        Rayfield:Notify({
            Title = "Failed",
            Content = "Could not find 5 pet slots",
            Duration = 3,
            Image = nil,
        })
        return false
    end
    
    print("Found", #slots, "pet slots")
    
    -- Click each slot and select a pet
    for i = 1, 5 do
        statusLabel:Set("Status: Adding pet " .. i .. "/5...")
        
        print("Clicking slot", i)
        -- Click the slot button to open pet inventory
        for _, connection in pairs(getconnections(slots[i].MouseButton1Click)) do
            connection:Fire()
        end
        
        task.wait(0.5)
        
        -- Select the pet from the inventory that opened
        if not clickPetInInventory(selectedPets[i]) then
            print("Failed to select pet", i)
        end
        
        task.wait(0.5)
    end
    
    task.wait(0.5)
    
    -- Click the convert button
    statusLabel:Set("Status: Clicking convert...")
    if not clickConvertButton(gui) then
        teleportBack()
        statusLabel:Set("Status: Failed to find convert button")
        return false
    end
    
    task.wait(1)
    
    -- Click the claim button
    statusLabel:Set("Status: Claiming reward...")
    clickClaimButton()
    
    task.wait(1)
    
    teleportBack()
    
    statusLabel:Set("Status: Rebirth complete!")
    Rayfield:Notify({
        Title = "Success",
        Content = "Rebirth process completed!",
        Duration = 3,
        Image = nil,
    })
    
    return true
end

RebirthTab:CreateToggle({
    Name = "Auto Rebirth Machine",
    CurrentValue = false,
    Flag = "AutoRebirthMachine",
    
    Callback = function(Value)
        getgenv().Functions.AutoRebirthMachine = Value
        task.spawn(function()
            while Functions.AutoRebirthMachine do
                useRebirthMachine()
                
                if Functions.AutoRebirthMachine then
                    for i = REBIRTH_INTERVAL, 0, -1 do
                        if not Functions.AutoRebirthMachine then break end
                        local minutes = math.floor(i / 60)
                        local seconds = i % 60
                        statusLabel:Set(string.format("Status: Next use in %02d:%02d", minutes, seconds))
                        task.wait(1)
                    end
                end
            end
            statusLabel:Set("Status: Disabled")
        end)
    end
})

local IntervalSlider = RebirthTab:CreateSlider({
    Name = "Machine Interval (minutes)",
    Range = {1, 120},
    Increment = 1,
    CurrentValue = 60,
    Flag = "MachineInterval",
    
    Callback = function(Value)
        REBIRTH_INTERVAL = Value * 60
        Rayfield:Notify({
            Title = "Interval Updated",
            Content = "Machine interval set to " .. Value .. " minutes",
            Duration = 2,
            Image = nil,
        })
    end
})

local InfoSection = RebirthTab:CreateSection("Information")

RebirthTab:CreateButton({
    Name = "Use Machine Now",
    Callback = function()
        local success = useRebirthMachine()
        if not success then
            Rayfield:Notify({
                Title = "Failed",
                Content = "Could not complete rebirth - check console",
                Duration = 3,
                Image = nil,
            })
        end
    end,
})

RebirthTab:CreateParagraph({
    Title = "How to Use",
    Content = "This script teleports you to the rebirth machine, automatically selects 5 Giant Bongo Kitty pets, clicks convert, and claims the reward. Make sure you have at least 5 unequipped, non-shiny, non-mythic Giant Bongo Kitty pets."
})

local UtilityTab = Window:CreateTab("Utility", nil)
local UtilitySection = UtilityTab:CreateSection("Script Control")

UtilityTab:CreateButton({
    Name = "Check Pet Count",
    Callback = function()
        local data = LocalData:Get()
        
        if not data then
            print("No LocalData found")
            Rayfield:Notify({
                Title = "Error",
                Content = "Could not access game data",
                Duration = 3,
                Image = nil,
            })
            return
        end
        
        print("=== PET DEBUG ===")
        print("Has Pets table:", data.Pets ~= nil)
        
        if data.Pets then
            local count = 0
            local bongoCats = 0
            local validBongoCats = 0
            
            for guid, pet in pairs(data.Pets) do
                count = count + 1
                if type(pet) == "table" and pet.Name == "Giant Bongo Kitty" then
                    bongoCats = bongoCats + 1
                    print("Found Bongo Cat:", guid)
                    print("  Equipped:", pet.Equipped or false)
                    print("  Shiny:", pet.Shiny or false)
                    print("  Mythic:", pet.Mythic or false)
                    
                    if not pet.Equipped and not pet.Shiny and not pet.Mythic then
                        validBongoCats = validBongoCats + 1
                    end
                end
            end
            
            print("Total pets:", count)
            print("Total Bongo Cats:", bongoCats)
            print("Valid Bongo Cats:", validBongoCats)
            
            Rayfield:Notify({
                Title = "Pet Count",
                Content = "Valid: " .. validBongoCats .. "\nTotal Bongo: " .. bongoCats .. "\nAll Pets: " .. count,
                Duration = 5,
                Image = nil,
            })
        else
            Rayfield:Notify({
                Title = "No Pets",
                Content = "Pets table not found in game data",
                Duration = 3,
                Image = nil,
            })
        end
    end,
})

UtilityTab:CreateButton({
    Name = "Debug: Explore GUI Details",
    Callback = function()
        print("\n=== DETAILED GUI EXPLORATION ===\n")
        
        -- Teleport first
        print("Step 1: Teleporting to machine...")
        if not teleportToRebirthMachine() then
            print("[FAILED] Could not teleport")
            return
        end
        print("[SUCCESS] Teleported successfully")
        
        task.wait(3) -- Wait for UI to load
        
        -- Get the BillboardGui we know exists
        print("\n=== EXPLORING BILLBOARDGUI ===")
        local workspace = game:GetService("Workspace")
        local billboardGui = workspace:FindFirstChild("RebirthMachine")
        if billboardGui then
            billboardGui = billboardGui:FindFirstChild("Activation")
        end
        if billboardGui then
            billboardGui = billboardGui:FindFirstChild("Root")
        end
        if billboardGui then
            billboardGui = billboardGui:FindFirstChild("BillboardGui")
        end
        
        if billboardGui then
            print("[SUCCESS] Found BillboardGui:", billboardGui:GetFullName())
            print("\n=== ALL DESCENDANTS (DETAILED) ===")
            
            local function printTree(obj, indent)
                indent = indent or ""
                print(indent .. "|- " .. obj.Name .. " [" .. obj.ClassName .. "]")
                
                -- Print important properties
                if obj:IsA("GuiObject") then
                    print(indent .. "|  Visible: " .. tostring(obj.Visible))
                    if obj:IsA("ScrollingFrame") then
                        print(indent .. "|  >> THIS IS A SCROLLINGFRAME <<")
                        print(indent .. "|  CanvasSize: " .. tostring(obj.CanvasSize))
                    end
                    if obj:IsA("GuiButton") or obj:IsA("TextButton") or obj:IsA("ImageButton") then
                        print(indent .. "|  >> THIS IS A BUTTON <<")
                        if obj:IsA("TextButton") then
                            print(indent .. "|  Text: " .. obj.Text)
                        end
                    end
                end
                
                for _, child in ipairs(obj:GetChildren()) do
                    printTree(child, indent .. "|  ")
                end
            end
            
            printTree(billboardGui)
            
            print("\n=== SEARCHING FOR KEY ELEMENTS ===")
            
            -- Find all frames
            print("\n[FRAMES] All Frames:")
            for _, obj in ipairs(billboardGui:GetDescendants()) do
                if obj:IsA("Frame") then
                    print("  - " .. obj.Name .. " | Visible: " .. tostring(obj.Visible))
                end
            end
            
            -- Find all scrolling frames
            print("\n[SCROLLINGFRAMES] All ScrollingFrames:")
            for _, obj in ipairs(billboardGui:GetDescendants()) do
                if obj:IsA("ScrollingFrame") then
                    print("  - " .. obj.Name .. " | Visible: " .. tostring(obj.Visible))
                    print("    Parent: " .. obj.Parent.Name)
                end
            end
            
            -- Find all buttons
            print("\n[BUTTONS] All Buttons:")
            for _, obj in ipairs(billboardGui:GetDescendants()) do
                if obj:IsA("GuiButton") or obj:IsA("TextButton") or obj:IsA("ImageButton") then
                    local text = obj:IsA("TextButton") and (" | Text: " .. obj.Text) or ""
                    print("  - " .. obj.Name .. " [" .. obj.ClassName .. "]" .. text)
                    print("    Visible: " .. tostring(obj.Visible))
                end
            end
            
            -- Find all TextLabels (might have important text)
            print("\n[TEXTLABELS] All TextLabels:")
            for _, obj in ipairs(billboardGui:GetDescendants()) do
                if obj:IsA("TextLabel") then
                    print("  - " .. obj.Name .. " | Text: " .. obj.Text)
                end
            end
            
        else
            print("[FAILED] Could not find BillboardGui!")
        end
        
        Rayfield:Notify({
            Title = "Exploration Complete",
            Content = "Check console (F9) - look for ScrollingFrame and buttons",
            Duration = 4,
            Image = nil,
        })
        
        task.wait(2)
        teleportBack()
    end,
})

UtilityTab:CreateButton({
    Name = "Destroy Script GUI",
    Callback = function()
        Rayfield:Notify({
            Title = "Destroying Script",
            Content = "GUI will close in 2 seconds...",
            Duration = 2,
            Image = nil,
        })
        
        task.wait(2)
        
        -- Stop all running functions
        if getgenv().Functions then
            for key, value in pairs(getgenv().Functions) do
                getgenv().Functions[key] = false
            end
        end
        
        -- Clear global functions
        getgenv().Functions = nil
        
        -- Destroy the Rayfield interface
        pcall(function()
            Rayfield:Destroy()
        end)
        
        print("=== SCRIPT DESTROYED ===")
        print("You can now reinject the script without rejoining")
    end,
})

Rayfield:LoadConfiguration()
